{"version":3,"file":"use-rn-async-queue.modern.js","sources":["../use-rn-async-queue.ts"],"sourcesContent":["import { useState, useRef, useCallback, useEffect } from 'react';\nimport nextTick from 'next-tick';\n\ntype QueueStats = {\n  numPending: number;\n  numInFlight: number;\n  numDone: number;\n}\n\ntype QueueTaskResult = {\n  id: any;\n  task(): Promise<any>;\n  result?: Promise<any>;\n  stats?: QueueStats;\n}\n\ntype Queue = {\n  add: (task: QueueTaskResult) => void;\n  stats: QueueStats;\n}\n\ntype QueueOpts = {\n  concurrency?: number;\n  done?: (result: QueueTaskResult) => void | Promise<void>;\n  drain?: () => void;\n  inflight?: (task: QueueTaskResult) => void;\n  isPaused?: boolean;\n}\n\nconst useRnAsyncQueue = (opts: QueueOpts): Queue => {\n  const { done, drain, inflight, isPaused } = opts;\n  let { concurrency } = opts;\n  if (concurrency < 1) concurrency = Infinity;\n\n  const [stats, setStats] = useState({\n    numPending: 0,\n    numInFlight: 0,\n    numDone: 0,\n  });\n\n  const drained = useRef(true);\n  const inFlight = useRef([] as QueueTaskResult[]);\n  const pending = useRef([] as QueueTaskResult[]);\n\n  useEffect(() => {\n    if(isPaused) return;\n    if (\n      stats.numDone > 0 &&\n      drain &&\n      inFlight.current.length === 0 &&\n      pending.current.length === 0 &&\n      !drained.current\n    ) {\n      drained.current = true;\n      return nextTick(drain);\n    }\n\n    while (\n      inFlight.current.length < concurrency &&\n      pending.current.length > 0\n    ) {\n      drained.current = false;\n      const task = pending.current.shift();\n      inFlight.current.push(task);\n      setStats((stats) => {\n        return {\n          ...stats,\n          numPending: stats.numPending - 1,\n          numInFlight: stats.numInFlight + 1,\n        };\n      });\n      inflight && inflight({ ...task, stats });\n      const result = task.task();\n      result\n        .then(() => {\n          inFlight.current.pop();\n          setStats((stats) => {\n            return {\n              ...stats,\n              numInFlight: stats.numInFlight - 1,\n              numDone: stats.numDone + 1,\n            };\n          });\n          done && done({ ...task, result, stats });\n        })\n        .catch(() => {\n          inFlight.current.pop();\n          setStats((stats) => {\n            return {\n              ...stats,\n              numInFlight: stats.numInFlight - 1,\n              numDone: stats.numDone + 1,\n            };\n          });\n          done && done({ ...task, result, stats });\n        });\n    }\n  }, [concurrency, done, drain, inflight, stats]);\n\n  const add = useCallback((task: QueueTaskResult) => {\n    pending.current.push(task);\n    setStats((stats) => {\n      return {\n        ...stats,\n        numPending: stats.numPending + 1,\n      };\n    });\n  }, []);\n\n  return { add, stats };\n}\n\nexport { useRnAsyncQueue };\nexport type { Queue, QueueOpts, QueueStats, QueueTaskResult };\n"],"names":["useRnAsyncQueue","opts","done","drain","inflight","isPaused","concurrency","Infinity","stats","setStats","useState","numPending","numInFlight","numDone","drained","useRef","inFlight","pending","useEffect","current","length","nextTick","task","shift","push","_extends","result","then","pop","catch","add","useCallback"],"mappings":"0UA6BM,MAAAA,EAAmBC,IACvB,MAAMC,KAAEA,EAAIC,MAAEA,EAAKC,SAAEA,EAAQC,SAAEA,GAAaJ,EAC5C,IAAIK,YAAEA,GAAgBL,EAClBK,EAAc,IAAGA,EAAcC,UAEnC,MAAOC,EAAOC,GAAYC,EAAS,CACjCC,WAAY,EACZC,YAAa,EACbC,QAAS,IAGLC,EAAUC,GAAO,GACjBC,EAAWD,EAAO,IAClBE,EAAUF,EAAO,IAEvBG,EAAU,KACR,IAAGb,EAAH,CACA,GACEG,EAAMK,QAAU,GAChBV,GAC4B,IAA5Ba,EAASG,QAAQC,QACU,IAA3BH,EAAQE,QAAQC,SACfN,EAAQK,QAGT,OADAL,EAAQK,SAAU,EACXE,EAASlB,GAGlB,KACEa,EAASG,QAAQC,OAASd,GAC1BW,EAAQE,QAAQC,OAAS,GACzB,CACAN,EAAQK,SAAU,EAClB,MAAMG,EAAOL,EAAQE,QAAQI,QAC7BP,EAASG,QAAQK,KAAKF,GACtBb,EAAUD,GACRiB,EAAA,CAAA,EACKjB,EAAK,CACRG,WAAYH,EAAMG,WAAa,EAC/BC,YAAaJ,EAAMI,YAAc,KAGrCR,GAAYA,EAAQqB,EAAA,CAAA,EAAMH,EAAI,CAAEd,WAChC,MAAMkB,EAASJ,EAAKA,OACpBI,EACGC,KAAK,KACJX,EAASG,QAAQS,MACjBnB,EAAUD,GACRiB,EACKjB,GAAAA,GACHI,YAAaJ,EAAMI,YAAc,EACjCC,QAASL,EAAMK,QAAU,KAG7BX,GAAQA,EAAIuB,EAAMH,CAAAA,EAAAA,EAAMI,CAAAA,SAAQlB,aAEjCqB,MAAM,KACLb,EAASG,QAAQS,MACjBnB,EAAUD,GACRiB,KACKjB,EAAK,CACRI,YAAaJ,EAAMI,YAAc,EACjCC,QAASL,EAAMK,QAAU,KAG7BX,GAAQA,EAAIuB,EAAMH,GAAAA,EAAMI,CAAAA,SAAQlB,UAAO,EAE5C,CAnDY,CAmDZ,EACA,CAACF,EAAaJ,EAAMC,EAAOC,EAAUI,IAExC,MAAMsB,EAAMC,EAAaT,IACvBL,EAAQE,QAAQK,KAAKF,GACrBb,EAAUD,GACRiB,EAAA,GACKjB,EACHG,CAAAA,WAAYH,EAAMG,WAAa,IAGrC,EAAG,IAEH,MAAO,CAAEmB,MAAKtB"}